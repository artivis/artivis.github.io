<!doctype html><!-- This site was created with Hugo Blox. https://hugoblox.com --><!-- Last Published: July 4, 2024 --><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=generator content="Hugo Blox Builder 5.9.7"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><script src=/js/mathjax-config.js></script><link rel=stylesheet href=/css/vendor-bundle.min.26c458e6907dc03073573976b7f4044e.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous media=print onload='this.media="all"'><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js integrity crossorigin=anonymous async></script><link rel=stylesheet href=/css/wowchemy.140328149f1241122bc1de776a5ae522.css><link rel=stylesheet href=/css/libs/chroma/github-light.min.css title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=/css/libs/chroma/github-dark.min.css title=hl-dark media=print onload='this.media="all"' disabled><script async src="https://www.googletagmanager.com/gtag/js?id=G-3HDCJG0J2J"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}function trackOutboundLink(e,t){gtag("event","click",{event_category:"outbound",event_label:e,transport_type:"beacon",event_callback:function(){t!=="_blank"&&(document.location=e)}}),console.debug("Outbound link clicked: "+e)}function onClickCallback(e){if(e.target.tagName!=="A"||e.target.host===window.location.host)return;trackOutboundLink(e.target,e.target.getAttribute("target"))}gtag("js",new Date),gtag("config","G-3HDCJG0J2J",{anonymize_ip:!0}),gtag("set",{cookie_flags:"SameSite=None;Secure"}),document.addEventListener("click",onClickCallback,!1)</script><meta name=author content="Jérémie Deray"><meta name=description content="I&rsquo;ve been advocating in several past posts for the use of LXD as a virtual development environment - see for instance &ldquo;Setting up ROS 2 Jazzy with LXD&rdquo;. But when setting up such environment for ROS 2, we find ourselves downloading hundreds of packages which may take some times."><link rel=alternate hreflang=en href=https://artivis.github.io/post/2024/apt-cache/><link rel=canonical href=https://artivis.github.io/post/2024/apt-cache/><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hud2d1771ce140e1d1fd4d0e59d51cebc4_11712_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hud2d1771ce140e1d1fd4d0e59d51cebc4_11712_180x180_fill_lanczos_center_3.png><meta name=theme-color content="#1565c0"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://artivis.github.io/media/icon_hud2d1771ce140e1d1fd4d0e59d51cebc4_11712_512x512_fill_lanczos_center_3.png"><meta property="og:type" content="article"><meta property="og:site_name" content="Home to artivis"><meta property="og:url" content="https://artivis.github.io/post/2024/apt-cache/"><meta property="og:title" content="Setting up an APT cache | Home to artivis"><meta property="og:description" content="I&rsquo;ve been advocating in several past posts for the use of LXD as a virtual development environment - see for instance &ldquo;Setting up ROS 2 Jazzy with LXD&rdquo;. But when setting up such environment for ROS 2, we find ourselves downloading hundreds of packages which may take some times."><meta property="og:image" content="https://artivis.github.io/media/icon_hud2d1771ce140e1d1fd4d0e59d51cebc4_11712_512x512_fill_lanczos_center_3.png"><meta property="og:locale" content="en"><meta property="article:published_time" content="2024-06-03T00:00:00+00:00"><meta property="article:modified_time" content="2024-06-03T00:00:00+00:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://artivis.github.io/post/2024/apt-cache/"},"headline":"Setting up an APT cache","datePublished":"2024-06-03T00:00:00Z","dateModified":"2024-06-03T00:00:00Z","author":{"@type":"Person","name":"Jérémie Deray"},"publisher":{"@type":"Organization","name":"Home to artivis","logo":{"@type":"ImageObject","url":"https://artivis.github.io/media/icon_hud2d1771ce140e1d1fd4d0e59d51cebc4_11712_192x192_fill_lanczos_center_3.png"}},"description":"I\u0026rsquo;ve been advocating in several past posts for the use of LXD as a virtual development environment - see for instance \u0026ldquo;Setting up ROS 2 Jazzy with LXD\u0026rdquo;. But when setting up such environment for ROS 2, we find ourselves downloading hundreds of packages which may take some times."}</script><script src=https://cdn.jsdelivr.net/gh/osano/cookieconsent@3.1.1/build/cookieconsent.min.js integrity="sha512-yXXqOFjdjHNH1GND+1EO0jbvvebABpzGKD66djnUfiKlYME5HGMUJHoCaeE4D5PTG2YsSJf6dwqyUUvQvS0vaA==" crossorigin=anonymous></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/osano/cookieconsent@3.1.1/build/cookieconsent.min.css integrity="sha512-LQ97camar/lOliT/MqjcQs5kWgy6Qz/cCRzzRzUCfv0fotsCTC9ZHXaPQmJV8Xu/PVALfJZ7BDezl5lW3/qBxg==" crossorigin=anonymous><script>window.addEventListener("load",function(){window.cookieconsent.initialise({palette:{popup:{background:"#1565c0",text:"rgb(255, 255, 255)"},button:{background:"rgb(255, 255, 255)",text:"#1565c0"}},theme:"classic",content:{message:"This website uses cookies to ensure you get the best experience on our website.",dismiss:"Got it!",link:"Learn more",href:"https://www.cookiesandyou.com"}})})</script><title>Setting up an APT cache | Home to artivis</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=5db58eb47151d42d524e0048c00222fc><script src=/js/wowchemy-init.min.2cadea5a50079c63724e95d3dac5110a.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=Close><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search class=form-control aria-label=Search...></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><div class="page-header header--fixed"><header class=header--fixed><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ cd /home/</span>
<span class=logo__cursor style=animation-duration:2s></span></div></a></a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Home to artivis</a></div><div class="navbar-collapse main-menu-item collapse justify-content-end" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class="nav-link active" href=/post><span>Posts</span></a></li><li class=nav-item><a class=nav-link href=/tag><span>Tags</span></a></li><li class=nav-item><a class=nav-link href=/publication><span>Publications</span></a></li><li class=nav-item><a class=nav-link href=/about><span>About</span></a></li><li class=nav-item><a class=nav-link href=/contact><span>Contact</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item>|</li><li class=nav-item><a class="nav-link js-search" href=# aria-label=Search><i class="fas fa-search" aria-hidden=true></i></a></li><li class="nav-item dropdown theme-dropdown"><a href=# class=nav-link data-toggle=dropdown aria-haspopup=true aria-label="Display preferences"><i class="fas fa-adjust" aria-hidden=true></i></a><div class=dropdown-menu><a href=# class="dropdown-item js-set-theme-light"><span>Light</span>
</a><a href=# class="dropdown-item js-set-theme-dark"><span>Dark</span>
</a><a href=# class="dropdown-item js-set-theme-auto"><span>Automatic</span></a></div></li></ul></div></nav></header></div><div class=page-body><div class="container-fluid docs"><div class="row flex-xl-nowrap"><div class="d-none d-xl-block col-xl-2 docs-toc"><div class=top-toc><a href=#>Contents</a></div><nav id=TableOfContents><ul><li><a href=#creating-a-proxy>Creating a proxy</a><ul><li><a href=#keeping-an-eye>Keeping an eye</a></li></ul></li><li><a href=#creating-a-client>Creating a client</a></li><li><a href=#some-metrics>Some metrics</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div><main class="col-12 col-md-0 col-xl-10 py-md-3 pl-md-5 docs-content" role=main><article class=article><div class="article-container pt-3"><h1>Setting up an APT cache</h1><p class=page-subtitle>Speeding up upgrades</p><div class=article-metadata><span class=article-date>Jun 3, 2024
</span><span class=middot-divider></span>
<span class=article-reading-time>6 min read</span></div></div><div class=article-container><div class=article-style><p>I&rsquo;ve been advocating in several past posts for the use of <a href=https://canonical.com/lxd target=_blank rel=noopener>LXD</a> as a virtual development environment - see for instance <a href=/post/2024/ros2-jazzy>&ldquo;Setting up ROS 2 Jazzy with LXD&rdquo;</a>.
But when setting up such environment for ROS 2,
we find ourselves downloading hundreds of packages which may take some times.</p><p>There are several ways we can address this and we are going to explore one here that has the advantages of being rather simple and generalise beyond LXD and ROS 2.
That solution is to cache our packages in an apt proxy.</p><p>In this post we&rsquo;re going to make use of <a href=https://canonical.com/lxd target=_blank rel=noopener>LXD</a>,
<a href=https://cloudinit.readthedocs.io/en/latest/index.html target=_blank rel=noopener>cloud-init</a> and addresse ROS 2 specifically but none of those are absolutely necessary and a similar setup can be replicated in a different scenario.</p><p>Let&rsquo;s get started.</p><h2 id=creating-a-proxy>Creating a proxy</h2><p>First thing first,
we shall set up a container that will act as the apt proxy and locally cache the debs.</p><p>So let&rsquo;s start by creating said container:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>lxc launch ubuntu:24.04 apt-proxy
</span></span></code></pre></div><p>Once instantiated,
we can then shell into the container and update/upgrade it for good measure:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>lxc shell apt-proxy
</span></span><span class=line><span class=cl>root@apt-proxy:~$ apt update <span class=o>&amp;&amp;</span> apt upgrade -y
</span></span></code></pre></div><p>Hereafter, the commands are run inside the &lsquo;apt-proxy&rsquo; container.</p><p>In our proxy, we will use the <a href=https://www.unix-ag.uni-kl.de/~bloch/acng/ target=_blank rel=noopener>apt-cacher-ng</a> project.
To best describe apt-cacher-ng, let&rsquo;s quote it&rsquo;s documentation:</p><blockquote><p>[apt-cacher-ng is a] caching proxy. Specialized for package files from Linux distributors, primarily for Debian (and Debian based) distributions</p></blockquote><p>And at this point, that&rsquo;s pretty much all we need to know as it is pretty much &lsquo;install & forget&rsquo;. So let&rsquo;s do just that.</p><p>To install it enter:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apt install apt-cacher-ng
</span></span></code></pre></div><p>After that, make sure that the service is running:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ systemctl status apt-cacher-ng
</span></span><span class=line><span class=cl>● apt-cacher-ng.service - Apt-Cacher NG software download proxy
</span></span><span class=line><span class=cl>     Loaded: loaded <span class=o>(</span>/usr/lib/systemd/system/apt-cacher-ng.service<span class=p>;</span> enabled<span class=p>;</span> preset: enabled<span class=o>)</span>
</span></span><span class=line><span class=cl>     Active: active <span class=o>(</span>running<span class=o>)</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p>And that&rsquo;s it, the caching mechanism it set up and listening by default on port 3142.</p><p>Before going any further,
wouldn&rsquo;t it be nice if this very container used the caching mechanism?
To do so, create the file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi /etc/apt/apt.conf.d/02proxy
</span></span></code></pre></div><p>with the following content:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>Acquire::http { Proxy &#34;http://127.0.0.1:3142&#34;; };
</span></span></code></pre></div><p>With this, the apt-proxy LXD container will use the caching as well.</p><p>I&rsquo;ve created a cloud-init config <a href=https://gist.github.com/artivis/f1b201ae78fd182cc6c6dccd0abd0fa1 target=_blank rel=noopener>available on GitHub</a> to easily launch this proxy container with the following one-liner:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>lxc launch ubuntu:24.04 apt-proxy --config<span class=o>=</span>user.user-data<span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span>curl -L https://gist.githubusercontent.com/artivis/f1b201ae78fd182cc6c6dccd0abd0fa1/raw/apt-proxy.cloud-init.yaml<span class=k>)</span><span class=s2>&#34;</span>
</span></span></code></pre></div><h3 id=keeping-an-eye>Keeping an eye</h3><p>Before moving on, let&rsquo;s point out that we can keep an eye on the logs of the cacher as they are produced.
This will be helpfull to make sure that everything goes as planned.
To do so, enter the following in a terminal:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tail -f /var/log/apt-cacher-ng/apt-cacher.log
</span></span></code></pre></div><h2 id=creating-a-client>Creating a client</h2><p>Typically, a cloud-init configuration for ROS 2 is something along the lines of the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>#cloud-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apt</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>sources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ros2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>source</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;deb [arch=amd64] http://packages.ros.org/ros2/ubuntu {{ v1.distro_release }} main&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>keyid</span><span class=p>:</span><span class=w> </span><span class=l>C1CF 6E31 E6BA DE88 68B1 72B4 F42E D6FB AB17 C654</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>package_upgrade</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>packages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>build-essential</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>python3-colcon-common-extensions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>ros-jazzy-ros-base</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span></code></pre></div><p>Installing ROS 2, whether a minimal install or a full desktop one,
will usually install a lot of packages.
That&rsquo;s the whole reason we&rsquo;re setting up a cache in the first place!</p><p>So how can we point our new ROS 2 container to the proxy?
The simplest solution is to install the <a href=https://github.com/terceiro/auto-apt-proxy target=_blank rel=noopener>auto-apt-proxy</a> package.
This project is pretty much a bash script that &ldquo;autodetect common [local] APT proxy setups&rdquo;.</p><p>To install it, we add the following to our cloud-init config:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl>#cloud-config
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gi>+ bootcmd:
</span></span></span><span class=line><span class=cl><span class=gi>+   - [ cloud-init-per, once, apt-proxy-aptupdate, apt-get, update ]
</span></span></span><span class=line><span class=cl><span class=gi>+   - [ cloud-init-per, once, apt-proxy-aptinstall, apt-get, install, auto-apt-proxy ]
</span></span></span></code></pre></div><p>This will make sure that the auto-apt-proxy package is be installed sufficiently early in the cloud-init process that subsequent calls to apt (such as the one operated by the &lsquo;packages&rsquo; keyword) will hit our proxy and thus our apt cache.
All of that happens rather automagically.</p><p>Note that all in all, we only install the <code>auto-apt-proxy</code> package.</p><p>Alright, let us make sure that everything work.
First we shall create a client container:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>lxc launch ubuntu:24.04 jazzy-lxc --config<span class=o>=</span>user.user-data<span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span>curl -L https://gist.githubusercontent.com/artivis/0357fe03a5ae459bee8c55823fbb0af8/raw/ros2.cloudinit.yaml<span class=k>)</span><span class=s2>&#34;</span>
</span></span></code></pre></div><p>Note that I&rsquo;m using in the command above a cloud-init configuration file that is <a href=https://gist.github.com/artivis/0357fe03a5ae459bee8c55823fbb0af8 target=_blank rel=noopener>available on GitHub</a>.</p><p>While the container is instantiating,
let&rsquo;s have a look on our cacher logs:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tail -f /var/log/apt-cacher-ng/apt-cacher.log
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>1720023357<span class=p>|</span>I<span class=p>|</span>14844<span class=p>|</span>10.203.148.193<span class=p>|</span>archive.ubuntu.com/ubuntu/dists/noble/InRelease
</span></span><span class=line><span class=cl>1720023357<span class=p>|</span>O<span class=p>|</span>102<span class=p>|</span>10.203.148.193<span class=p>|</span>archive.ubuntu.com/ubuntu/dists/noble/InRelease
</span></span><span class=line><span class=cl>1720023357<span class=p>|</span>I<span class=p>|</span>14844<span class=p>|</span>10.203.148.193<span class=p>|</span>archive.ubuntu.com/ubuntu/dists/noble-updates/InRelease
</span></span><span class=line><span class=cl>1720023357<span class=p>|</span>O<span class=p>|</span>102<span class=p>|</span>10.203.148.193<span class=p>|</span>archive.ubuntu.com/ubuntu/dists/noble-updates/InRelease
</span></span><span class=line><span class=cl>1720023360<span class=p>|</span>I<span class=p>|</span>5159<span class=p>|</span>10.203.148.193<span class=p>|</span>ros2/dists/noble/InRelease
</span></span><span class=line><span class=cl>1720023360<span class=p>|</span>O<span class=p>|</span>4933<span class=p>|</span>10.203.148.193<span class=p>|</span>ros2/dists/noble/InRelease
</span></span><span class=line><span class=cl>1720023360<span class=p>|</span>I<span class=p>|</span>14844<span class=p>|</span>10.203.148.193<span class=p>|</span>security.ubuntu.com/ubuntu/dists/noble-security/InRelease
</span></span><span class=line><span class=cl>1720023360<span class=p>|</span>O<span class=p>|</span>102<span class=p>|</span>10.203.148.193<span class=p>|</span>security.ubuntu.com/ubuntu/dists/noble-security/InRelease
</span></span><span class=line><span class=cl>1720023360<span class=p>|</span>I<span class=p>|</span>14844<span class=p>|</span>10.203.148.193<span class=p>|</span>archive.ubuntu.com/ubuntu/dists/noble-backports/InRelease
</span></span><span class=line><span class=cl>1720023360<span class=p>|</span>O<span class=p>|</span>102<span class=p>|</span>10.203.148.193<span class=p>|</span>archive.ubuntu.com/ubuntu/dists/noble-backports/InRelease
</span></span><span class=line><span class=cl>1720023360<span class=p>|</span>I<span class=p>|</span>868602<span class=p>|</span>10.203.148.193<span class=p>|</span>ros2/dists/noble/main/binary-amd64/Packages.gz
</span></span><span class=line><span class=cl>1720023360<span class=p>|</span>O<span class=p>|</span>868326<span class=p>|</span>10.203.148.193<span class=p>|</span>ros2/dists/noble/main/binary-amd64/Packages.gz
</span></span><span class=line><span class=cl>1720023365<span class=p>|</span>I<span class=p>|</span>69304<span class=p>|</span>10.203.148.193<span class=p>|</span>ros2/pool/main/p/python3-colcon-core/python3-colcon-core_0.17.0-1_all.deb
</span></span><span class=line><span class=cl>1720023365<span class=p>|</span>O<span class=p>|</span>69018<span class=p>|</span>10.203.148.193<span class=p>|</span>ros2/pool/main/p/python3-colcon-core/python3-colcon-core_0.17.0-1_all.deb
</span></span><span class=line><span class=cl>1720023365<span class=p>|</span>I<span class=p>|</span>43798<span class=p>|</span>10.203.148.193<span class=p>|</span>ros2/pool/main/p/python3-catkin-pkg-modules/python3-catkin-pkg-modules_1.0.0-1_all.deb
</span></span><span class=line><span class=cl>1720023365<span class=p>|</span>O<span class=p>|</span>43527<span class=p>|</span>10.203.148.193<span class=p>|</span>ros2/pool/main/p/python3-catkin-pkg-modules/python3-catkin-pkg-modules_1.0.0-1_all.deb
</span></span><span class=line><span class=cl>1720023365<span class=p>|</span>I<span class=p>|</span>6844<span class=p>|</span>10.203.148.193<span class=p>|</span>ros2/pool/main/p/python3-colcon-alias/python3-colcon-alias_0.1.1-1_all.deb
</span></span><span class=line><span class=cl>1720023365<span class=p>|</span>O<span class=p>|</span>6562<span class=p>|</span>10.203.148.193<span class=p>|</span>ros2/pool/main/p/python3-colcon-alias/python3-colcon-alias_0.1.1-1_all.deb
</span></span><span class=line><span class=cl>1720023365<span class=p>|</span>I<span class=p>|</span>328416<span class=p>|</span>10.203.148.193<span class=p>|</span>archive.ubuntu.com/ubuntu/pool/main/n/node-jquery/libjs-jquery_3.6.1+dfsg+~3.5.14-1_all.deb
</span></span><span class=line><span class=cl>1720023365<span class=p>|</span>O<span class=p>|</span>328029<span class=p>|</span>10.203.148.193<span class=p>|</span>archive.ubuntu.com/ubuntu/pool/main/n/node-jquery/libjs-jquery_3.6.1+dfsg+~3.5.14-1_all.deb
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p>Oh wow. There is a lot that got printed.
Upon closer inspection,
we can essentially notice that the first 12 lines correspond to an (apt) update,
while the following ones are packages being downloaded.
It looks like it works!</p><p>Another way to verify that is to shell inside the client container:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>lxc shell jazzy-lxc
</span></span></code></pre></div><p>and call apt with some debug logs as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ apt update -o Debug::Acquire::http<span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl>Using auto proxy detect command: /usr/bin/auto-apt-proxy
</span></span><span class=line><span class=cl>auto detect <span class=nb>command</span> returned: <span class=s1>&#39;http://10.203.148.160:3142&#39;</span>
</span></span><span class=line><span class=cl>Using auto proxy detect command: /usr/bin/auto-apt-proxy
</span></span><span class=line><span class=cl>auto detect <span class=nb>command</span> returned: <span class=s1>&#39;http://10.203.148.160:3142&#39;</span>
</span></span><span class=line><span class=cl>Using auto proxy detect command: /usr/bin/auto-apt-proxy
</span></span><span class=line><span class=cl>auto detect <span class=nb>command</span> returned: <span class=s1>&#39;http://10.203.148.160:3142&#39;</span>
</span></span><span class=line><span class=cl>0% <span class=o>[</span>Working<span class=o>]</span>GET http://security.ubuntu.com/ubuntu/dists/noble-security/InRelease HTTP/1.1
</span></span><span class=line><span class=cl>Host: security.ubuntu.com
</span></span><span class=line><span class=cl>Cache-Control: max-age<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>Accept: text/*
</span></span><span class=line><span class=cl>If-Modified-Since: Wed, <span class=m>03</span> Jul <span class=m>2024</span> 14:01:45 GMT
</span></span><span class=line><span class=cl>User-Agent: Debian APT-HTTP/1.3 <span class=o>(</span>2.7.14<span class=o>)</span> non-interactive
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>GET http://packages.ros.org/ros2/ubuntu/dists/noble/InRelease HTTP/1.1
</span></span><span class=line><span class=cl>Host: packages.ros.org
</span></span><span class=line><span class=cl>Cache-Control: max-age<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>Accept: text/*
</span></span><span class=line><span class=cl>If-Modified-Since: Tue, <span class=m>25</span> Jun <span class=m>2024</span> 14:39:05 GMT
</span></span><span class=line><span class=cl>User-Agent: Debian APT-HTTP/1.3 <span class=o>(</span>2.7.14<span class=o>)</span> non-interactive
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p>where &lsquo;10.203.148.160&rsquo; should be the IP address of the <code>apt-proxy</code> container.</p><p>As before, we should see some new logs printed by the cacher,
logs that correspond to the update call.</p><p>At last, for extra good measure,
we can verify that our ROS 2 packages are indeed cached on our proxy server.
To do so, we can enter the following command in the <code>apt-proxy</code> container:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ls /var/cache/apt-cacher-ng/packages.ros.org/pool/main/*/
</span></span><span class=line><span class=cl>/var/cache/apt-cacher-ng/ros2/pool/main/p/:
</span></span><span class=line><span class=cl>python3-catkin-pkg-modules  python3-colcon-cmake              python3-colcon-installed-package-information  python3-colcon-package-information  python3-colcon-recursive-crawl  python3-rosdistro-modules
</span></span><span class=line><span class=cl>python3-colcon-alias        python3-colcon-common-extensions  python3-colcon-mixin                          python3-colcon-package-selection    python3-colcon-ros              python3-rospkg-modules
</span></span><span class=line><span class=cl>python3-colcon-bash         python3-colcon-core               python3-colcon-notification                   python3-colcon-parallel-executor    python3-colcon-zsh              python3-vcstool
</span></span><span class=line><span class=cl>python3-colcon-cd           python3-colcon-defaults           python3-colcon-output                         python3-colcon-powershell           python3-rosdep
</span></span><span class=line><span class=cl>python3-colcon-clean        python3-colcon-devtools           python3-colcon-override-check                 python3-colcon-python-setup-py      python3-rosdep-modules
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/var/cache/apt-cacher-ng/ros2/pool/main/r/:
</span></span><span class=line><span class=cl>ros-jazzy-action-msgs                             ros-jazzy-ament-lint-common           ros-jazzy-pybind11-vendor            ros-jazzy-ros2run                               ros-jazzy-rpyutils
</span></span><span class=line><span class=cl>ros-jazzy-actionlib-msgs                          ros-jazzy-ament-package               ros-jazzy-python-cmake-module        ros-jazzy-ros2service                           ros-jazzy-sensor-msgs
</span></span><span class=line><span class=cl>ros-jazzy-ament-cmake                             ros-jazzy-ament-pep257                ros-jazzy-rcl                        ros-jazzy-ros2topic                             ros-jazzy-sensor-msgs-py
</span></span><span class=line><span class=cl>ros-jazzy-ament-cmake-auto                        ros-jazzy-ament-uncrustify            ros-jazzy-rcl-action                 ros-jazzy-rosbag2                               ros-jazzy-service-msgs
</span></span><span class=line><span class=cl>ros-jazzy-ament-cmake-copyright                   ros-jazzy-ament-xmllint               ros-jazzy-rcl-interfaces             ros-jazzy-rosbag2-compression                   ros-jazzy-shape-msgs
</span></span><span class=line><span class=cl>ros-jazzy-ament-cmake-core                        ros-jazzy-builtin-interfaces          ros-jazzy-rcl-lifecycle              ros-jazzy-rosbag2-compression-zstd              ros-jazzy-shared-queues-vendor
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p>Yep, there are plenty packages there.</p><h2 id=some-metrics>Some metrics</h2><p>As a very scientific benchmark,
we are going to spawn the very same container,
with the same ROS 2 ready cloud-init configuration we used previously,
with and without the <code>apt-proxy</code> container running.</p><p>We recall the command to launch the container:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>lxc launch ubuntu:24.04 jazzy-lxc --config<span class=o>=</span>user.user-data<span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span>curl -L https://gist.githubusercontent.com/artivis/0357fe03a5ae459bee8c55823fbb0af8/raw/ros2.cloudinit.yaml<span class=k>)</span><span class=s2>&#34;</span>
</span></span></code></pre></div><p>In both cases, we&rsquo;ll wait for cloud-init to finish:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>lxc <span class=nb>exec</span> jazzy-lxc -- cloud-init status --wait
</span></span></code></pre></div><p>And as a measure, we will rely on cloud-init with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>lxc <span class=nb>exec</span> jazzy-lxc -- cloud-init analyze show
</span></span></code></pre></div><p>And the results are:</p><table><thead><tr><th>exec time (s)</th><th style=text-align:center>apt_configure</th><th style=text-align:center>package_update_upgrade_install</th><th style=text-align:center>total</th></tr></thead><tbody><tr><td>w/o proxy</td><td style=text-align:center>18.44</td><td style=text-align:center>179.95</td><td style=text-align:center>240.47</td></tr><tr><td>with proxy</td><td style=text-align:center>03.57</td><td style=text-align:center>39.59</td><td style=text-align:center>90.66</td></tr></tbody></table><p>The results are clear,
we observe a ~2.5x speed increase in apt operations.</p><p>Note that for good measure I ran this test a couple times.
The results between runs varies a bit of course but not significantly given the difference.</p><!--
## On using mirrors

### Configuring the proxy for ROS 2 mirrors

We will create a file listing ROS 2 repository mirrors.

```bash
vi /etc/apt-cacher-ng/ros2_mirror
```

Then we edit the `apt-cacher-ng` configuration file:

```bash
vi /etc/apt-cacher-ng/acng.conf
```

and append the following:

```diff
+ file:ros2_mirror /packages.ros.org ; http://packages.ros.org/ros2/ubuntu
```
--><h2 id=conclusion>Conclusion</h2><p>We have seen in this post how to set up an apt proxy to locally cache debs allowing us to speed up the instantiation of ROS 2 ready LXD containers.
And as we&rsquo;ve seen, it is fairly simple. Gaining a ~2.5x speed increase in apt operations at the cost of &lsquo;fire & forget&rsquo;ing a server container and installing a single package in our clients is a pretty good deal.</p><p>Remember that while we examplified the setup here using LXD and a ROS 2 dev environment,
this can be replicated in other scenario as well.</p><p>At last, the apt-cacher-ng comes loaded with features and options that you can define in the file <code>/etc/apt-cacher-ng/acng.conf</code>.
I leave it to you to explore that and tweak the cacher to your needs.</p><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title><button id=goTop class=btn-top><svg class="arrow up" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="5 0 50 80"><polyline fill="none" stroke="#fff" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" points="0.375, 35.375 28.375, 0.375 58.67, 35.375"/></svg></button></a></li></ul><style>.btn-feedback{display:inline-block}.btn-feedback-negative{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><div class="d-print-none widget--feedback"><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><p class="feedback--response feedback--response-positive">Glad to hear it!</p><p class="feedback--response feedback--response-negative">Sorry to hear that. <a href=https://github.com/artivis/artivis.github.io/discussions/new/choose target=_blank rel=noopener>Please let me know how it can improved</a>.</p><button class="btn btn-primary mb-4 btn-feedback btn-feedback-positive">
😍 Yes
</button>
<button class="btn btn-primary mb-4 btn-feedback btn-feedback-negative">
😕 No</button></div><script>const btnYes=document.querySelector(".btn-feedback-positive"),btnNo=document.querySelector(".btn-feedback-negative"),responseYes=document.querySelector(".feedback--response-positive"),responseNo=document.querySelector(".feedback--response-negative"),disableButtons=()=>{btnYes.disabled=!0,btnNo.disabled=!0},sendFeedback=e=>{if(typeof gtag!="function")return;gtag("event","click",{event_category:"page_rating",event_label:window.location.pathname,value:e,transport_type:"beacon",event_callback:function(){console.debug(`✅ Feedback sent ${e}`)}})};btnYes.addEventListener("click",()=>{console.debug("Feedback response: 😍"),responseYes.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(1)}),btnNo.addEventListener("click",()=>{console.debug("Feedback response: 😡"),responseNo.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(0)})</script></div><p class=edit-page><a href=https://github.com/artivis/artivis.github.io/edit/main/content/post/2024/apt-cache.md><i class="fas fa-pen pr-2"></i>Edit this page</a></p><div class=article-tags><a class="badge badge-light" href=/tag/tutorial/>Tutorial</a>
<a class="badge badge-light" href=/tag/apt/>APT</a>
<a class="badge badge-light" href=/tag/lxc/>LXC</a>
<a class="badge badge-light" href=/tag/lxd/>LXD</a>
<a class="badge badge-light" href=/tag/ros/>ROS</a>
<a class="badge badge-light" href=/tag/ros-2/>ROS 2</a></div><div class=share-box><ul class=share><li><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fartivis.github.io%2Fpost%2F2024%2Fapt-cache%2F&amp;text=Setting+up+an+APT+cache" target=_blank rel=noopener class=share-btn-twitter aria-label=twitter><i class="fab fa-twitter"></i></a></li><li><a href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fartivis.github.io%2Fpost%2F2024%2Fapt-cache%2F&amp;t=Setting+up+an+APT+cache" target=_blank rel=noopener class=share-btn-facebook aria-label=facebook><i class="fab fa-facebook"></i></a></li><li><a href="mailto:?subject=Setting%20up%20an%20APT%20cache&amp;body=https%3A%2F%2Fartivis.github.io%2Fpost%2F2024%2Fapt-cache%2F" target=_blank rel=noopener class=share-btn-email aria-label=envelope><i class="fas fa-envelope"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Fartivis.github.io%2Fpost%2F2024%2Fapt-cache%2F&amp;title=Setting+up+an+APT+cache" target=_blank rel=noopener class=share-btn-linkedin aria-label=linkedin-in><i class="fab fa-linkedin-in"></i></a></li><li><a href="whatsapp://send?text=Setting+up+an+APT+cache%20https%3A%2F%2Fartivis.github.io%2Fpost%2F2024%2Fapt-cache%2F" target=_blank rel=noopener class=share-btn-whatsapp aria-label=whatsapp><i class="fab fa-whatsapp"></i></a></li><li><a href="https://service.weibo.com/share/share.php?url=https%3A%2F%2Fartivis.github.io%2Fpost%2F2024%2Fapt-cache%2F&amp;title=Setting+up+an+APT+cache" target=_blank rel=noopener class=share-btn-weibo aria-label=weibo><i class="fab fa-weibo"></i></a></li></ul></div><div class="article-widget content-widget-hr"><h3>Related</h3><ul><li><a href=/post/2024/ros2-jazzy/>Setting up ROS 2 Jazzy with LXD</a></li><li><a href=/post/2022/ros2-humble/>Setting up ROS 2 Humble with LXD</a></li><li><a href=/post/2020/ros-foxy-install/>Get started with ROS 2 Foxy today with LXD</a></li><li><a href=/post/2020/lxc/>ROS Noetic development workflow in LXC</a></li><li><a href=/post/2024/lxc-isolated/>How to isolate an LXC</a></li></ul></div></div></article></main></div></div></div><div class=page-footer><div class=container><footer class=site-footer><p class="powered-by copyright-license-text">Jérémie Deray © 2024. This work is licensed under
<a href=https://creativecommons.org/licenses/by-nc-nd/4.0 rel="noopener noreferrer" target=_blank aria-label="Creative Commons"><i class="fab fa-creative-commons fa-xl" aria-hidden=true></i>
<i class="fab fa-creative-commons-by fa-xl" aria-hidden=true></i>
<i class="fab fa-creative-commons-nc fa-xl" aria-hidden=true></i>
<i class="fab fa-creative-commons-nd fa-xl" aria-hidden=true></i></a></p><p class=powered-by></p></footer></div></div><script src=/js/vendor-bundle.min.391d344a129df56f7ad674c2c2ed04e8.js></script><script id=search-hit-fuse-template type=text/x-template>
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script><script src=https://cdn.jsdelivr.net/gh/krisk/Fuse@v3.2.1/dist/fuse.min.js integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/gh/julmot/mark.js@8.11.1/dist/jquery.mark.min.js integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin=anonymous></script><script id=page-data type=application/json>{"use_headroom":true}</script><script src=/js/wowchemy-headroom.db4755770454eb63685f8de785c0a172.js type=module></script><script src=/en/js/wowchemy.min.7f5ebaff62ae468cff8bb3dd1337bb9b.js></script><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i> Copy
</a><a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i> Download</a><div id=modal-error></div></div></div></div></div><script src=/js/wowchemy-publication.9c0e895144aef5a693008b5c5d450147.js type=module></script></body></html>